<template name="calendar_dropdown">
  {{#if calendar_id}}
  {{#let evs=upcoming_events nxt=next_event}}
  <div class="btn-group text-left bb-calendar-events">
    <button class="btn btn-small {{#unless nxt}}btn-inverse{{else if less nxt 300000}}btn-warning{{else if less nxt 3600000}}btn-success{{else}}btn-primary{{/unless}} dropdown-toggle" data-toggle="dropdown" title="Events">
      {{#if evs.count}}{{evs.count}}{{/if}}
      <i class="fas fa-calendar"></i>
      <span class="caret"></span>
    </button>
    <ul class="dropdown-menu pull-right" id="bb-calendar-events-dropdown">
      <li>
        <a href="https://calendar.google.com/calendar?cid={{calendar_id}}" target="_blank">
        <i class="fas fa-calendar-plus"></i> Add Google Calendar
        </a>
      </li>
      {{#each evs}}
        {{> calendar_event event=this}}
      {{/each}}
    </ul>
  </div>
  {{/let}}
  {{/if}}
</template>

<template name="calendar_strip">
  {{#if calendar_id}}
  {{#let evs=upcoming_events}}
  <h2>
    <a href="https://calendar.google.com/calendar?cid={{calendar_id}}"
       target="_blank"
       title="Add Google Calendar"><i class="fas fa-calendar-plus"></i></a>
    {{#if evs.count}}{{evs.count}}{{else}}No{{/if}} Upcoming Event{{#if plural evs.count}}s{{/if}}
  </h2>
  {{#if evs.count}}
  <ul id="bb-calendar-events-strip">
    {{#each evs}}
      {{> calendar_event event=this}}
    {{/each}}
  </ul>
  {{/if}}
  {{/let}}
  {{/if}}
</template>

<template name="calendar_event">
  <li class="bb-calendar-event" data-event-id="{{event._id}}">
    <div class="bb-event-summary">{{event.summary}}</div>
    <div class="bb-event-time"><i class="fas fa-clock" title="Time"></i> {{pretty_ts timestamp=event.start}}-{{pretty_ts timestamp=event.end}} ({{pretty_ts timestamp=event.start style="brief future"}})</div>
    <div class="bb-event-attendees">
      {{#if includes event.attendees currentUser._id}}<i class="fas fa-user-minus bb-event-unattend" title="I won't attend"></i>{{else}}<i class="fas fa-user-plus bb-event-attend" title="I'll attend"></i>{{/if}}
      {{#each attendee in event.attendees}}
        {{>gravatar nick=attendee size=16 title=(nickOrName attendee)}}
      {{else}}
        (Nobody)
      {{/each}}
    </div>
    {{#if event.puzzle}}
      <div class="bb-event-puzzle"><i class="fas fa-puzzle-piece" title="Puzzle"></i> {{>link id=event.puzzle}}</div>
    {{/if}}
    {{#if event.location}}
      {{#if url event.location}}
        <div class="bb-event-link"><i class="fas fa-link" title="Link"></i> <a href="{{event.location}}" target="_blank">{{event.location}}</a></div>
      {{else}}
        <div class="bb-event-location"><i class="fas fa-map-marker" title="Location"></i> <a href="https://maps.google.com/maps/search/{{event.location}}" target="_blank">{{event.location}}</a></div>
      {{/if}}
    {{/if}}
  </li>
</template>

<template name="calendar_attachable_events">
  {{#let attachable=attachable_events}}
  {{#if attachable.count}}
  <span class="btn-group bb-calendar-attachable"
  ><button class="btn btn-link dropdown-toggle" data-toggle="dropdown" title="Attach Event"><i class="fas fa-calendar-plus"></i></button><ul class="dropdown-menu bb-events-attachable-list"
  >{{#each event in attachable}}{{>calendar_event event=event}}{{/each
      }}</ul></span>
  {{/if}}
  {{/let}}
</template>