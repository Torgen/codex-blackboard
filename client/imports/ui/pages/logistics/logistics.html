<template name="logistics">
  <div class="bb-logistics">
    <section class="bb-logistics-metas">
      <div class="bb-logistics-controls">
        <div class="btn-group">
          <span class="btn btn-mini btn-success disabled active"><i class="fas fa-plus"></i> New</span>
          <button id="bb-logistics-new-round" class="btn btn-mini btn-inverse {{#if creatingRound}}open{{/if}}">
            <i class="fas fa-folder-open"></i> Round
            {{#if creatingRound}}
              <ul class="dropdown-menu stay-open">
                <li>{{> create_object type="rounds" done=doneCreatingRound}}</li>
              </ul>
            {{/if}}
          </button>
          <button id="bb-logistics-new-meta" class="btn btn-mini btn-primary" data-toggle="dropdown" data-target="#bb-logistics-new-meta">
            <i class="fas fa-filter"></i> Meta
            <ul class="dropdown-menu">
              <li class="disabled"><a>Round</a></li>
              {{#each rounds}}
                <li><a class="round-name">{{name}}</a></li>
              {{/each}}
            </ul>
          </button>
          <button id="bb-logistics-new-standalone" class="btn btn-mini" data-toggle="dropdown" data-target="#bb-logistics-new-standalone">
            <i class="fas fa-puzzle-piece"></i> Puzzle
            <ul class="dropdown-menu">
              <li class="disabled"><a>Round</a></li>
              {{#each rounds}}
                <li><a class="round-name">{{name}}</a></li>
              {{/each}}
            </ul>
          </button>
        </div>
        <span id="bb-logistics-delete" class="btn btn-mini btn-danger disabled active" title="Drag a puzzle here to delete it."><i class="fas fa-trash"></i> Delete</span>
      </div>
      {{#each r in rounds}}
        {{#each m in (metas r)}}
          {{>logistics_meta round=r meta=m}}
        {{/each}}
        {{#if equal creatingMeta r._id}}
          <div class="bb-logistics-meta" style="--num-feeders:0">
            <header>
              <div class="round">{{r.name}}</div>
              {{> create_object type="puzzles" done=doneCreatingMeta params=(metaParams r._id)}}
            </header>
            <div class="feeders">
              {{#each puzzle in p}}
                {{> logistics_puzzle puzzle}}
              {{/each}}
            </div>
          </div>
        {{/if}}
        {{#let sa=(standalone r)}}
          {{#if any sa.length (equal creatingStandalone r._id) u}}
          <div class="bb-logistics-standalone" style="--num-feeders: calc({{length}}{{#if equal creatingStandalone r._id}} + 1{{/if}})">
            {{#each s in sa}}
              {{> logistics_puzzle s}}
            {{/each}}
            {{#if equal creatingStandalone r._id}}
              {{>create_object type="puzzles" done=doneCreatingStandalone params=(puzzleParams r._id)}}
            {{/if}}
            {{#if u}}
            {{/if}}
          </div>
          {{/if}}
        {{/let}}
      {{/each}}
      {{#with unfeeding}}
        <div class="bb-logistics-standalone" style="--num-feeders: 1">
          {{>logistics_puzzle}}
        </div>
      {{/with}}
    </section>
    {{> callins_table}}
  </div>
</template>

<template name="logistics_puzzle_presence">
  {{#with presenceForScope "jitsi"}}
    <i class="presence fas fa-video"><span class="count">{{this}}</span></i>
  {{else with presenceForScope "chat"}}
    <i class="presence fas fa-comment-alt"><span class="count">{{this}}</span></i>
  {{/with}}
</template>

<template name="logistics_puzzle_events">
  {{#unless no_events}}
    {{#with soonest_ending_current_event}}
      <i class="events fas fa-calendar-day" title="Event &ldquo;{{summary}}&rdquo; ends {{pretty_ts timestamp=end style="brief future"}}"></i>
    {{else with next_future_event}}
      <i class="events fas fa-calendar-week" title="Event &ldquo;{{summary}}&rdquo; starts {{pretty_ts timestamp=start style="brief future"}}"></i>
    {{else}}
      <i class="events fas fa-calendar-times" title="All events over"></i>
    {{/with}}
  {{/unless}}
</template>

<template name="logistics_puzzle">
  <a href="/puzzles/{{_id}}" class="{{#if draggingIn}}dragged-link{{else if willDelete}}would-disappear{{/if}} puzzle puzzles-link {{#if solved}}solved{{else if stuck this}}stuck{{/if}}" draggable="true">
    {{>logistics_puzzle_events this}}
    <span class="fill"><span class="puzzle-name">{{name}}</span></span>
    {{>logistics_puzzle_presence this}}
  </a>
</template>

<template name="logistics_meta">
  {{#let p=puzzles}}
  <div class="bb-logistics-meta {{#if willDelete}}would-disappear{{/if}} {{#if meta.solved}}solved{{else if stuck this}}stuck{{/if}} {{#if draggingLink}}dragover{{/if}}" style="--meta-color: {{color}}; --num-feeders:calc({{p.length}}{{#if creatingFeeder}} + 1{{/if}}{{#if all draggingLink fromAnotherMeta (not draggingPuzzle)}} + 1{{/if}})">
    <header>
      <div class="round">{{round.name}}</div>
      <a href="/puzzles/{{meta._id}}" class="meta puzzles-link {{#if meta.solved}}solved{{else if stuck this}}stuck{{/if}}" draggable="true">
        {{>logistics_puzzle_events meta}}
        <span class="fill"><span class="puzzle-name">{{meta.name}}</span></span>
        {{>logistics_puzzle_presence meta}}
      </a>
      <btn class="btn btn-mini btn-inverse new-puzzle {{#if creatingFeeder}}active{{/if}}" title="Create new puzzle feeding this meta"><i class="fas fa-plus"></i> <i class="fas fa-puzzle-piece"></i></btn>
    </header>
    <div class="feeders">
      {{#each puzzle in p}}
        {{> logistics_puzzle puzzle}}
      {{/each}}
      {{#if creatingFeeder}}
        {{>create_object type="puzzles" done=doneCreatingFeeder params=feederParams}}
      {{/if}}
      {{#if draggingLink}}
        {{#if fromAnotherMeta}}
          {{>logistics_puzzle draggedPuzzle}}
        {{else unless draggedPuzzle}}
          <div class="puzzle dragged-link">Dragged Link</div>
        {{/if}}
      {{/if}}
    </div>
  </div>
  {{/let}}
</template>

<template name="logistics_topright_panel">
  <div class="bb-logistics-info">
    <div class="btn-toolbar">
      {{>onduty_control}}
    </div>
    {{>starred_messages canModify=mynick}}
  </div>
</template>
